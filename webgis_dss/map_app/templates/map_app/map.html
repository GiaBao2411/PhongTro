{% extends 'map_app/base.html' %}
{% block title %}Bản Đồ Tìm Kiếm & Thời Gian Di Chuyển{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #main-content { flex-grow: 1; display: flex; flex-direction: column; height: calc(100vh - 130px); }
    .map-container { flex-grow: 1; display: flex; overflow: hidden; height: 85vh; }
    #sidebar { width: 380px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 1000; overflow-y: auto; }
    #map { flex-grow: 1; height: 100%; }
    .room-card { cursor: pointer; border: 1px solid #eee; margin-bottom: 10px; padding: 12px; border-radius: 8px; transition: 0.2s; }
    .room-card:hover { border-color: #0d6efd; background: #f8f9fa; border-left: 4px solid #0d6efd; }
    .travel-table { font-size: 0.85rem; margin-top: 10px; }
    .rush-hour { color: #d63031; font-weight: bold; }
    .travel-box { background: #f1f3f5; border-radius: 8px; padding: 10px; margin-bottom: 15px; border: 1px solid #dee2e6; }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div id="sidebar" class="p-3">
        <h5 class="text-primary fw-bold mb-3"><i class="bi bi-map"></i> Tìm Kiếm Thông Minh</h5>
        
        <div class="mb-3">
            <label class="fw-bold small">Bán kính tìm kiếm (m):</label>
            <input type="number" id="radiusVal" class="form-control shadow-sm" value="2000">
        </div>

        <div class="mb-3">
            <label class="fw-bold small">Điểm gốc của bạn:</label>
            <input type="text" id="coords" class="form-control bg-light shadow-sm" readonly placeholder="Click trên bản đồ để chọn...">
        </div>

        <div id="travel-info-panel"></div>

        <hr>
        <div id="results-area">
            <p class="text-muted text-center mt-4 italic">Vui lòng chọn một điểm trên bản đồ để xem danh sách phòng trọ xung quanh.</p>
        </div>
    </div>
    <div id="map"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([10.7769, 106.7009], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    var userMarker, circleLayer, routeLayer;
    var roomMarkers = [];

    function clearMap() {
        if (circleLayer) map.removeLayer(circleLayer);
        if (routeLayer) map.removeLayer(routeLayer);
        roomMarkers.forEach(m => map.removeLayer(m));
        roomMarkers = [];
        document.getElementById('travel-info-panel').innerHTML = "";
    }

    map.on('click', function(e) {
        clearMap();
        if (userMarker) map.removeLayer(userMarker);
        
        userMarker = L.marker(e.latlng).addTo(map).bindPopup("Vị trí của bạn").openPopup();
        document.getElementById('coords').value = e.latlng.lat.toFixed(5) + "," + e.latlng.lng.toFixed(5);

        let r = document.getElementById('radiusVal').value;
        circleLayer = L.circle(e.latlng, {
            radius: r, 
            color: '#2ecc71', 
            fillColor: '#2ecc71', 
            fillOpacity: 0.1
        }).addTo(map);
        
        fetchRooms(e.latlng, r);
    });

    function fetchRooms(center, radius) {
        $.get(`/api/loc-phong/?lat=${center.lat}&lng=${center.lng}&radius=${radius}`, function(res) {
            displayRooms(res.rooms, center);
        });
    }

    function calculateTravelTime(distKm) {
        // Định nghĩa vận tốc: km/h
        const config = {
            motorcycle: { name: "Xe máy", normal: 30, rush: 18, icon: "bi-bicycle" },
            car: { name: "Ô tô", normal: 40, rush: 12, icon: "bi-car-front" },
            walking: { name: "Đi bộ", normal: 5, rush: 5, icon: "bi-person-walking" }
        };

        let html = `
            <div class="travel-box shadow-sm">
                <small class="fw-bold text-primary text-uppercase d-block mb-2">Ước tính thời gian đi:</small>
                <table class="table table-sm table-borderless mb-0 travel-table">
                    <thead>
                        <tr>
                            <th></th>
                            <th class="text-center small">Thường</th>
                            <th class="text-center small text-danger">Cao điểm</th>
                        </tr>
                    </thead>
                    <tbody>`;
        
        for (let key in config) {
            let m = config[key];
            let nTime = Math.round((distKm / m.normal) * 60);
            let rTime = Math.round((distKm / m.rush) * 60);
            html += `
                <tr>
                    <td><i class="${m.icon}"></i> ${m.name}</td>
                    <td class="text-center">${nTime}'</td>
                    <td class="text-center rush-hour">${rTime}'</td>
                </tr>`;
        }
        html += `</tbody></table></div>`;
        return html;
    }

    function displayRooms(rooms, center) {
        let area = document.getElementById('results-area');
        area.innerHTML = rooms.length ? `<p class="small text-muted mb-2">Tìm thấy ${rooms.length} phòng gần đây:</p>` : "<p class='text-center p-3'>Rất tiếc, không có phòng nào trong bán kính này.</p>";

        rooms.forEach(r => {
            // Tạo marker
            let m = L.marker([r.lat, r.lng]).addTo(map).bindPopup(`<b>${r.ten}</b>`);
            roomMarkers.push(m);

            // Tạo card sidebar
            let card = document.createElement('div');
            card.className = "room-card shadow-sm border p-2 mb-2 rounded";
            card.innerHTML = `
                <div class="fw-bold text-dark">${r.ten}</div>
                <div class="d-flex justify-content-between align-items-center mt-1">
                    <span class="text-danger fw-bold small">${r.gia.toLocaleString()} đ</span>
                    <span class="badge bg-secondary">${r.distance_km} km</span>
                </div>
            `;
            card.onclick = () => getDetailedRoute([center.lat, center.lng], [r.lat, r.lng], r.ten);
            area.appendChild(card);
        });
    }

    function getDetailedRoute(start, end, roomName) {
        if (routeLayer) map.removeLayer(routeLayer);
        
        $.get(`/api/dan-duong/?start_lat=${start[0]}&start_lng=${start[1]}&end_lat=${end[0]}&end_lng=${end[1]}`, function(res) {
            routeLayer = L.geoJSON(res, {
                style: { color: '#0984e3', weight: 6, opacity: 0.8 }
            }).addTo(map);
            map.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});
            
            let summary = res.features[0].properties.summary;
            let distKm = (summary.distance / 1000).toFixed(2);
            
            document.getElementById('travel-info-panel').innerHTML = `
                <div class="alert alert-info py-2 px-3 mb-2 shadow-sm border-0" style="background: #e7f1ff;">
                    <div class="fw-bold text-primary">${roomName}</div>
                    <small class="text-dark">Lộ trình thực tế: <b>${distKm} km</b></small>
                </div>
                ${calculateTravelTime(distKm)}
            `;
        });
    }
</script>
{% endblock %}