{% extends 'map_app/base.html' %}
{% block title %}B·∫£n ƒê·ªì T√¨m Ki·∫øm Th√¥ng Minh{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #main-content { flex-grow: 1; display: flex; flex-direction: column; height: calc(100vh - 76px); }
    .map-container { flex-grow: 1; display: flex; overflow: hidden; position: relative; }
    #sidebar { width: 350px; background: white; display: flex; flex-direction: column; border-right: 1px solid #ddd; z-index: 1000; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
    #map { flex-grow: 1; height: 100%; width: 100%; }
    .room-card { cursor: pointer; border-bottom: 1px solid #eee; padding: 10px; transition: 0.2s; background: #fff; position: relative; }
    .room-card:hover { background-color: #f0f8ff; border-color: #0d6efd; }
    
    /* CSS cho icon ng∆∞·ªùi d√πng */
    .user-pin-marker { background: transparent; border: none; }
    .pulse-animation {
        animation: pulse 2s infinite;
        border-radius: 50%;
        box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7);
    }
    @keyframes pulse {
        0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(211, 47, 47, 0.7); }
        70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
        100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(211, 47, 47, 0); }
    }
</style>
{% endblock %}

{% block content %}
<div class="map-container">
    <div id="sidebar" class="p-3">
        <h5 class="text-primary fw-bold mb-3"><i class="bi bi-search"></i> B·ªô L·ªçc T√¨m Ki·∫øm</h5>
        
        <div class="mb-3">
            <label class="fw-bold small">1. V·ªã tr√≠ c·ªßa b·∫°n (Click b·∫£n ƒë·ªì):</label>
            <div class="input-group">
                <input type="text" class="form-control" id="coords" placeholder="Ch∆∞a ch·ªçn ƒëi·ªÉm..." readonly style="background:#f8f9fa; font-size: 0.9rem;">
                <button class="btn btn-outline-secondary" onclick="locateUser()" title="V·ªã tr√≠ hi·ªán t·∫°i"><i class="bi bi-crosshair"></i></button>
            </div>
        </div>

        <div class="mb-3">
            <label class="fw-bold small mb-2">2. Ti√™u ch√≠ t√¨m ki·∫øm:</label>
            <div class="d-flex gap-3 bg-light p-2 rounded border">
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="searchMode" id="modeTime" value="time" checked onchange="toggleMode()">
                    <label class="form-check-label small fw-bold" for="modeTime"><i class="bi bi-clock"></i> Th·ªùi gian</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="searchMode" id="modeDistance" value="distance" onchange="toggleMode()">
                    <label class="form-check-label small fw-bold" for="modeDistance"><i class="bi bi-rulers"></i> Kho·∫£ng c√°ch</label>
                </div>
            </div>
        </div>

        <div class="mb-3 p-3 bg-white border rounded">
            <label class="fw-bold small mb-2 text-primary"><i class="bi bi-sliders"></i> T√πy ch·ªçn n√¢ng cao:</label>
            <select class="form-select mb-2" id="vehicleSelect">
                <option value="moto" selected>üõµ Xe m√°y (TB 35km/h)</option>
                <option value="car">üöó √î t√¥ (TB 30km/h)</option>
                <option value="walk">üö∂ ƒêi b·ªô (TB 5km/h)</option>
            </select>
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" id="rushHourCheck">
                <label class="form-check-label small text-danger fw-bold" for="rushHourCheck"><i class="bi bi-traffic-cone"></i> ƒêang gi·ªù cao ƒëi·ªÉm?</label>
                <div class="text-muted fst-italic" style="font-size: 0.75rem;">(Tr·ª´ hao th·ªùi gian k·∫πt xe)</div>
            </div>
        </div>

        <div class="mb-3 p-3 border rounded shadow-sm">
            <div id="inputTimeGroup">
                <label class="fw-bold small d-flex justify-content-between"><span>Th·ªùi gian t·ªëi ƒëa:</span><span class="text-primary fw-bold" id="timeDisplay">15 ph√∫t</span></label>
                <input type="range" class="form-range mt-2" id="inputTime" min="5" max="60" step="5" value="15" oninput="document.getElementById('timeDisplay').innerText = this.value + ' ph√∫t'">
            </div>
            <div id="inputDistanceGroup" style="display: none;">
                <label class="fw-bold small d-flex justify-content-between"><span>B√°n k√≠nh ƒëi:</span><span class="text-danger fw-bold" id="distDisplay">5 km</span></label>
                <input type="range" class="form-range mt-2" id="inputDist" min="1" max="30" step="1" value="5" oninput="document.getElementById('distDisplay').innerText = this.value + ' km'">
            </div>
        </div>

        <button onclick="timKiem()" class="btn btn-primary w-100 fw-bold mb-3 shadow-sm py-2"><i class="bi bi-geo-alt-fill"></i> T√åM KI·∫æM NGAY</button>
        <hr>
        <div id="results-area"><div class="text-center mt-5 text-muted opacity-50"><i class="bi bi-geo-alt" style="font-size: 3rem;"></i><p class="small mt-2">K·∫øt qu·∫£ s·∫Ω hi·ªán ·ªü ƒë√¢y...</p></div></div>
    </div>
    <div id="map"></div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([10.7769, 106.7009], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap' }).addTo(map);

    var userMarker=null, isochroneLayer=null, roomMarkers=[], routeLayer=null;

    // --- T·∫†O ICON CON NG∆Ø·ªúI (Thay th·∫ø icon ƒë·ªè c≈©) ---
    var humanIcon = L.divIcon({
        className: 'user-pin-marker',
        html: `
            <div style="position: relative; width: 50px; height: 60px;">
                <div class="pulse-animation" style="background-color: #d32f2f; width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 2px solid white; position: absolute; left: 5px; top: 0; z-index: 2;">
                    <i class="bi bi-person-fill" style="color: white; font-size: 24px;"></i>
                </div>
                <div style="width: 0; height: 0; border-left: 8px solid transparent; border-right: 8px solid transparent; border-top: 14px solid #d32f2f; position: absolute; bottom: 10px; left: 17px; z-index: 1;"></div>
                <div style="width: 20px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 50%; position: absolute; bottom: 8px; left: 15px;"></div>
            </div>
        `,
        iconSize: [50, 60],
        iconAnchor: [25, 60], // ƒêi·ªÉm nh·ªçn n·∫±m ƒë√∫ng v·ªã tr√≠ click
        popupAnchor: [0, -60]
    });

    // --- T·ª∞ ƒê·ªòNG T√åM KI·∫æM N·∫æU C√ì URL ?q=... ---
    $(document).ready(function() {
        const urlParams = new URLSearchParams(window.location.search);
        const query = urlParams.get('q');

        if (query) {
            document.getElementById('results-area').innerHTML = `<div class="text-center mt-3"><div class="spinner-border text-primary"></div><br>ƒêang t√¨m v·ªã tr√≠: <b>${query}</b>...</div>`;
            
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ", Ho Chi Minh City")}`)
            .then(res => res.json())
            .then(data => {
                if (data && data.length > 0) {
                    var lat = parseFloat(data[0].lat);
                    var lon = parseFloat(data[0].lon);
                    
                    if (userMarker) map.removeLayer(userMarker);
                    // D√πng humanIcon ·ªü ƒë√¢y
                    userMarker = L.marker([lat, lon], {icon: humanIcon}).addTo(map)
                        .bindPopup(`<b>${query}</b>`).openPopup();
                    
                    map.setView([lat, lon], 14);
                    document.getElementById('coords').value = lat.toFixed(5) + ", " + lon.toFixed(5);
                    timKiem();
                } else {
                    document.getElementById('results-area').innerHTML = "<p class='text-center text-danger'>Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n√†y :(</p>";
                }
            })
            .catch(err => alert("L·ªói ƒë·ªãnh v·ªã ƒë·ªãa ƒëi·ªÉm!"));
        }
    });

    function toggleMode() {
        var mode = document.querySelector('input[name="searchMode"]:checked').value;
        document.getElementById('inputTimeGroup').style.display = (mode==='time')?'block':'none';
        document.getElementById('inputDistanceGroup').style.display = (mode==='time')?'none':'block';
    }

    // Click b·∫£n ƒë·ªì -> Hi·ªán icon con ng∆∞·ªùi
    map.on('click', function(e) {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(e.latlng, {icon: humanIcon}).addTo(map).bindPopup("<b>V·ªã tr√≠ c·ªßa b·∫°n</b>").openPopup();
        document.getElementById('coords').value = e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
        if(routeLayer) map.removeLayer(routeLayer);
    });

    function locateUser() {
        map.locate({setView: true, maxZoom: 16});
    }
    map.on('locationfound', function(e) {
        if (userMarker) map.removeLayer(userMarker);
        userMarker = L.marker(e.latlng, {icon: humanIcon}).addTo(map).bindPopup("<b>V·ªã tr√≠ hi·ªán t·∫°i</b>").openPopup();
        document.getElementById('coords').value = e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
    });

    function timKiem() {
        if (!userMarker) { alert("Vui l√≤ng ch·ªçn 1 ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì!"); return; }
        var mode = document.querySelector('input[name="searchMode"]:checked').value;
        var val = (mode === 'time') ? document.getElementById('inputTime').value : document.getElementById('inputDist').value;
        var vehicle = document.getElementById('vehicleSelect').value;
        var rushHour = document.getElementById('rushHourCheck').checked;

        document.getElementById('results-area').innerHTML = '<div class="text-center mt-3"><div class="spinner-border text-primary"></div><br>ƒêang t√≠nh to√°n GIS...</div>';

        $.ajax({
            url: '/api/tim-kiem/', type: 'GET',
            data: { 'lat': userMarker.getLatLng().lat, 'lng': userMarker.getLatLng().lng, 'mode': mode, 'value': val, 'vehicle': vehicle, 'rush_hour': rushHour },
            success: function(res) {
                if (isochroneLayer) map.removeLayer(isochroneLayer);
                if (routeLayer) map.removeLayer(routeLayer);
                roomMarkers.forEach(m => map.removeLayer(m)); roomMarkers = [];
                document.getElementById('results-area').innerHTML = "";

                var color = (mode === 'time') ? '#1a237e' : '#d32f2f';
                isochroneLayer = L.geoJSON(res.polygon, { style: { color: color, weight: 2, opacity: 0.8, fillOpacity: 0.2 } }).addTo(map);
                map.fitBounds(isochroneLayer.getBounds());

                if (res.rooms.length === 0) {
                    document.getElementById('results-area').innerHTML = "<p class='text-center p-3 text-muted'>Kh√¥ng t√¨m th·∫•y ph√≤ng n√†o :(</p>";
                } else {
                    var unit = (mode === 'time') ? 'ph√∫t' : 'km';
                    document.getElementById('results-area').innerHTML = `<div class='alert alert-success fw-bold small p-2 mb-2'>üéâ T√¨m th·∫•y ${res.rooms.length} ph√≤ng (trong ${val} ${unit})</div>`;
                    res.rooms.forEach(room => {
                        var giaHienThi = parseInt(room.gia).toLocaleString('vi-VN') + ' VNƒê';
                        var imgTag = room.img ? `<img src="${room.img}" style="width:100%; height:100px; object-fit:cover; margin-bottom:5px;">` : '';
                        var popupContent = `${imgTag}<b>${room.ten}</b><br><span class="text-danger fw-bold">${giaHienThi}</span><br><small>${room.dia_chi}</small><div class="mt-2 d-flex justify-content-between"><a href="/phong-tro/${room.id}/" target="_blank" class="btn btn-sm btn-info text-white">Xem</a> <button class="btn btn-sm btn-primary" onclick="danDuong(${room.lat}, ${room.lng})">ƒêi t·ªõi</button></div>`;
                        var m = L.marker([room.lat, room.lng]).bindPopup(popupContent).addTo(map);
                        roomMarkers.push(m);
                        var card = `<div class="room-card"><div onclick="window.open('/phong-tro/${room.id}/', '_blank')" style="cursor:pointer"><div class="fw-bold text-primary text-truncate">${room.ten}</div><div class="text-danger fw-bold my-1">${giaHienThi}</div><small class="text-muted d-block text-truncate"><i class="bi bi-geo-alt"></i> ${room.dia_chi}</small></div><button class="btn btn-sm btn-light border position-absolute top-0 end-0 m-2" title="D·∫´n ƒë∆∞·ªùng" onclick="danDuong(${room.lat}, ${room.lng})"><i class="bi bi-sign-turn-right-fill text-primary"></i></button></div>`;
                        document.getElementById('results-area').innerHTML += card;
                    });
                }
            }, error: function() { alert("L·ªói k·∫øt n·ªëi Server!"); document.getElementById('results-area').innerHTML = ""; }
        });
    }

    function danDuong(endLat, endLng) {
        if (!userMarker) { alert("Vui l√≤ng ch·ªçn v·ªã tr√≠ c·ªßa b·∫°n tr∆∞·ªõc!"); return; }
        var startLat = userMarker.getLatLng().lat, startLng = userMarker.getLatLng().lng;
        var vehicle = document.getElementById('vehicleSelect').value;
        var rushHour = document.getElementById('rushHourCheck').checked;

        map.closePopup(); 
        var popupWait = L.popup().setLatLng([(startLat+endLat)/2, (startLng+endLng)/2]).setContent('<div class="text-center">‚è≥ ƒêang t√¨m ƒë∆∞·ªùng...</div>').openOn(map);

        $.ajax({
            url: '/api/dan-duong/',
            data: { 'start_lat': startLat, 'start_lng': startLng, 'end_lat': endLat, 'end_lng': endLng, 'vehicle': vehicle, 'rush_hour': rushHour },
            success: function(res) {
                map.closePopup(popupWait);
                if (routeLayer) map.removeLayer(routeLayer);
                var routeColor = (vehicle === 'walk') ? '#ff9800' : '#2e7d32';
                routeLayer = L.geoJSON(res, { style: { color: routeColor, weight: 6, opacity: 0.8 } }).addTo(map);
                map.fitBounds(routeLayer.getBounds(), {padding: [50, 50]});
                
                var summary = res.features[0].properties.summary;
                var dist = (summary.distance/1000).toFixed(1); 
                var dur = (summary.duration/60).toFixed(0);      
                var iconVeh = (vehicle==='walk') ? 'üö∂' : (vehicle==='moto' ? 'üõµ' : 'üöó');
                if(rushHour) iconVeh += 'üî•'; 
                
                L.popup().setLatLng([(startLat+endLat)/2, (startLng+endLng)/2]).setContent(`<div class="text-center"><b>${iconVeh} L·ªô tr√¨nh ${vehicle==='walk'?'ƒëi b·ªô':'l√°i xe'}:</b><br><span class="fs-5 fw-bold text-primary">${dur} ph√∫t</span><br><small class="text-muted">Qu√£ng ƒë∆∞·ªùng: ${dist} km</small></div>`).openOn(map);
            }, error: function() { alert("Kh√¥ng t√¨m th·∫•y ƒë∆∞·ªùng ƒëi!"); }
        });
    }
</script>
{% endblock %}