<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartRent - H·ªá Th·ªëng T√¨m Tr·ªç Th√¥ng Minh</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f6f9; display: flex; flex-direction: column; height: 100vh; margin: 0; }
        
        /* 1. THANH MENU (HEADER) */
        .navbar { background-color: #1a237e; /* Xanh Navy ƒë·∫≠m */ padding: 15px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .navbar-brand { color: white !important; font-weight: 700; font-size: 1.5rem; text-transform: uppercase; }
        .nav-link { color: rgba(255,255,255,0.8) !important; font-weight: 500; margin-left: 15px; }
        .nav-link:hover { color: #ffca28 !important; /* M√†u v√†ng khi di chu·ªôt */ }
        .btn-login { background-color: #ffca28; color: #1a237e; font-weight: bold; border: none; padding: 8px 20px; border-radius: 20px; }
        .btn-login:hover { background-color: #ffb300; }

        /* 2. B·ªê C·ª§C CH√çNH */
        .main-container { flex-grow: 1; display: flex; overflow: hidden; position: relative; }
        
        /* C·ªôt Tr√°i: T√¨m ki·∫øm & K·∫øt qu·∫£ */
        #sidebar { width: 400px; background: white; display: flex; flex-direction: column; border-right: 1px solid #ddd; z-index: 1000; box-shadow: 2px 0 10px rgba(0,0,0,0.05); }
        .search-box { padding: 20px; background: #fff; border-bottom: 1px solid #eee; }
        .search-title { font-size: 1.1rem; font-weight: 700; color: #1a237e; margin-bottom: 15px; display: flex; align-items: center; }
        
        /* Form nh·∫≠p li·ªáu ƒë·∫πp h∆°n */
        .form-control { border-radius: 8px; border: 1px solid #ced4da; padding: 10px; }
        .form-control:focus { border-color: #1a237e; box-shadow: 0 0 0 0.2rem rgba(26, 35, 126, 0.25); }
        .btn-search { width: 100%; padding: 12px; background: #d32f2f; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; margin-top: 10px; transition: 0.3s; }
        .btn-search:hover { background: #b71c1c; }

        /* Danh s√°ch k·∫øt qu·∫£ */
        #results-area { flex-grow: 1; overflow-y: auto; padding: 15px; background: #f8f9fa; }
        
        /* Th·∫ª ph√≤ng tr·ªç (Card) */
        .room-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 15px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .room-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: #1a237e; }
        
        .room-img-placeholder { height: 120px; background: #e0e0e0; display: flex; align-items: center; justify-content: center; color: #757575; font-size: 3rem; }
        .room-info { padding: 15px; }
        .room-name { font-weight: bold; font-size: 1rem; color: #333; margin-bottom: 5px; line-height: 1.3; }
        .room-price { color: #d32f2f; font-weight: bold; font-size: 1.1rem; }
        .room-addr { font-size: 0.85rem; color: #666; margin-top: 5px; display: flex; align-items: flex-start; }
        .room-addr i { margin-right: 5px; margin-top: 3px; }

        /* C·ªôt Ph·∫£i: B·∫£n ƒë·ªì */
        #map { flex-grow: 1; height: 100%; }

        /* Footer nh·ªè */
        .footer-bar { background: #fff; padding: 5px 10px; font-size: 0.8rem; text-align: center; color: #888; border-top: 1px solid #eee; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid px-4">
            <a class="navbar-brand" href="#"><i class="bi bi-building"></i> üè† SmartRent <span style="font-size: 0.8rem; opacity: 0.7">WebGIS</span></a>
            <div class="collapse navbar-collapse justify-content-end">
                <ul class="navbar-nav align-items-center">
                    <li class="nav-item"><a class="nav-link" href="#">Trang ch·ªß</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Thu√™ ph√≤ng</a></li>
                    <li class="nav-item"><a class="nav-link" href="#">Tin t·ª©c</a></li>
                    <li class="nav-item ms-3"><button class="btn-login">ƒêƒÉng tin</button></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container">
        
        <div id="sidebar">
            <div class="search-box">
                <div class="search-title">üîç B·ªô L·ªçc T√¨m Ki·∫øm</div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">1. Ch·ªçn ƒëi·ªÉm l√†m vi·ªác</label>
                    <input type="text" class="form-control" id="coords" placeholder="Click ch·ªçn tr√™n b·∫£n ƒë·ªì..." readonly style="background-color: #e9ecef;">
                    <small class="text-muted" style="font-size: 0.8rem">H√£y click v√†o n∆°i b·∫°n ƒëi h·ªçc/ƒëi l√†m.</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">2. Th·ªùi gian di chuy·ªÉn (ph√∫t)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="time" value="15" min="5" max="60">
                        <span class="input-group-text">ph√∫t</span>
                    </div>
                </div>

                <button onclick="timKiem()" class="btn-search">T√åM PH√íNG NGAY</button>
            </div>

            <div id="results-area">
                <div class="text-center text-muted mt-5">
                    <img src="https://cdn-icons-png.flaticon.com/512/1865/1865269.png" width="60" style="opacity: 0.5; margin-bottom: 10px;">
                    <p>Ch∆∞a c√≥ k·∫øt qu·∫£.<br>Vui l√≤ng ch·ªçn v·ªã tr√≠ v√† b·∫•m t√¨m ki·∫øm.</p>
                </div>
            </div>
            
            <div class="footer-bar">¬© 2026 SmartRent DSS Project</div>
        </div>

        <div id="map"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        // 1. Kh·ªüi t·∫°o b·∫£n ƒë·ªì
        var map = L.map('map').setView([10.7769, 106.7009], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        var userMarker = null;
        var isochroneLayer = null;
        var roomMarkers = [];

        // Icon Marker ƒê·∫πp h∆°n
        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/markers-default/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
        });

        // 2. Click ch·ªçn ƒëi·ªÉm
        map.on('click', function(e) {
            if (userMarker) map.removeLayer(userMarker);
            userMarker = L.marker(e.latlng, {icon: redIcon}).addTo(map).bindPopup("<b>V·ªã tr√≠ c·ªßa b·∫°n</b>").openPopup();
            
            // ƒêi·ªÅn t·ªça ƒë·ªô v√†o √¥ input ƒë·∫πp
            document.getElementById('coords').value = e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
        });

        // 3. H√†m x·ª≠ l√Ω logic
        function timKiem() {
            var time = document.getElementById('time').value;
            
            if (!userMarker) {
                alert("‚ö†Ô∏è Vui l√≤ng click ch·ªçn ƒëi·ªÉm l√†m vi·ªác tr√™n b·∫£n ƒë·ªì tr∆∞·ªõc!");
                return;
            }

            var btn = document.querySelector('.btn-search');
            var resultArea = document.getElementById('results-area');
            
            // Hi·ªáu ·ª©ng Loading
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang t√≠nh to√°n...';
            btn.disabled = true;

            $.ajax({
                url: '/api/tim-kiem/',
                data: {
                    'lat': userMarker.getLatLng().lat,
                    'lng': userMarker.getLatLng().lng,
                    'time': time
                },
                success: function(res) {
                    btn.innerHTML = 'T√åM PH√íNG NGAY';
                    btn.disabled = false;

                    // X√≥a k·∫øt qu·∫£ c≈©
                    if (isochroneLayer) map.removeLayer(isochroneLayer);
                    roomMarkers.forEach(m => map.removeLayer(m));
                    roomMarkers = [];
                    resultArea.innerHTML = "";

                    // V·∫Ω v√πng xanh
                    isochroneLayer = L.geoJSON(res.polygon, {
                        style: { color: '#1a237e', opacity: 0.6, fillOpacity: 0.2, weight: 2 }
                    }).addTo(map);
                    map.fitBounds(isochroneLayer.getBounds());

                    // X·ª≠ l√Ω danh s√°ch k·∫øt qu·∫£
                    if (res.rooms.length === 0) {
                        resultArea.innerHTML = `
                            <div class="text-center mt-5 text-muted">
                                <h5>Kh√¥ng t√¨m th·∫•y ph√≤ng n√†o :(</h5>
                                <p>Th·ª≠ tƒÉng th·ªùi gian di chuy·ªÉn l√™n xem sao!</p>
                            </div>`;
                    } else {
                        // Hi·ªán s·ªë l∆∞·ª£ng t√¨m th·∫•y
                        resultArea.innerHTML = `<div class="mb-3 fw-bold text-success">üéâ T√¨m th·∫•y ${res.rooms.length} ph√≤ng tr·ªç ph√π h·ª£p:</div>`;
                        
                        res.rooms.forEach(room => {
                            // T·∫°o Marker tr√™n b·∫£n ƒë·ªì
                            var m = L.marker([room.lat, room.lng])
                                .bindPopup(`<b>${room.ten}</b><br><span style="color:red">${room.gia.toLocaleString()} ƒë</span>`)
                                .addTo(map);
                            roomMarkers.push(m);

                            // T·∫°o Th·∫ª Card b√™n tr√°i
                            var card = `
                                <div class="room-card" onclick="map.flyTo([${room.lat}, ${room.lng}], 16)">
                                    <div class="room-img-placeholder">üè†</div>
                                    <div class="room-info">
                                        <div class="room-name">${room.ten}</div>
                                        <div class="room-price">${room.gia.toLocaleString()} VNƒê/th√°ng</div>
                                        <div class="room-addr">üìç ${room.dia_chi}</div>
                                    </div>
                                </div>
                            `;
                            resultArea.innerHTML += card;
                        });
                    }
                },
                error: function(err) {
                    console.log(err);
                    btn.innerHTML = 'T√åM PH√íNG NGAY';
                    btn.disabled = false;
                    alert("L·ªói k·∫øt n·ªëi! Ki·ªÉm tra l·∫°i Server.");
                }
            });
        }
    </script>
</body>
</html>